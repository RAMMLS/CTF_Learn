# Сетевой уровень. Протокол IP 
```
- Для того чтобы выполнить длинное подключение недостаточно адресации канального уровня. 
 - **Сетевой уровень** призван связать большое количество различных локальных сетей.
```
 
# Протокол IP (Internet protocol) - маршрутизируемый протокол сетевого уровня стека TCP/IP.
## Существуют 2 версии протокола: 
[1] - IPv4
[2] - IPv6

## Основные функции 
- Адресация 
- Маршрутизация 
- Фрагментация и сборка (разбиение пакетов при необходимости)
Адресация в сетях IP происходит по уникальным числовым идентификаторам - IP-адресам 

# Я ТЕБЯ ПО АЙПИ ВЫЧИСЛЮ!!! 

## IPv4 - 32b
## IPv6 - 128b

## Представление пакета IP

![[Pasted image 20251119180114.png]]

**В пакете указываются адреса (IP-addresses)

Кроме них добавляется служебная информация:
[1] **Время жизни (Time to live пакета) - необходимо для маршрутизации**
[2] **Протокол верхнего уровня для корректной совместимости**
[3] **Подсчитывается контрольная сумма**

# Маршрутизация пакетов

**На сетевом уровне пакет проходит большое количество узлов - маршрутизаторов (Роутеров)**


## Существуют таблицы маршрутизации: 
- Статические - заполняются вручную
- Динамические - алгоритмы предусмотренные **RIP** || **OSPF**

*Шлюз по умолчанию - узел, служащий для маршрутизации в случаях с неизвестными маршрутами*

# Сети IP
* **Обращение по IP проще чем по MAC**
* **IP сети позволяют масштабировать**

- ## Публичный IP-адрес - уникале в глобальном Интернет
- ## Частный IP-адрес - принадлежит специальному диапазону, не маршрутизируемом в интернете

## Диапазоны частных IP-адресов:
```

- `10.0.0.0/8` (10.0.0.0 – 10.255.255.255)
    
- `172.16.0.0/12` (172.16.0.0 – 172.31.255.255)
    
- `192.168.0.0/16` (192.168.0.0 – 192.168.255.255)
    
- Реже можно встретить подсеть `100.64.0.0/10`
```


# Маска подсети и расчет узлов

## Число после '/' называется **префиксом сети** и определяет какая часть IP-адреса отностися к сети, а какая - к хостам

### Формула для расчета числа узлов в подсети: 
```math
N=(2^(32)−m)−2
```

- *2^(32) - общее число бит в IPv4*
- m - длина маски (префикс)
- -2 - исключаем адрес сети и широковещательный адрес
# Технология NAT 
```
## Общее количество IPv4-адресов = 2^32 = 4.3 млрд
```

### NAT (Network address translation) - механизм в сетях TCP/IP, позволяющий преобразовывать IP-адреса на транзитных устройствах


### OSPF (Open Shortest Path First) — это протокол динамической маршрутизации, основанный на алгоритме поиска кратчайшего пути

# Вспомогательные протоколы

**Для корректной работы сети на сетевом уровне, помимо IP используются служебные протоколы (ARP, DHCP, ICMP)**

# DHCP 

- Работает на прикладном уровне
- Клиенты могут автоматически получать IP-адрес и сетевые настройки
- Функционирует в сети отдельный DHCP-сервер
## Алгоритм работы DHCP:

- `DHCP Discover` — клиент отправляет широковещательный запрос на поиск сервера.
    
- `DHCP Offer` — сервер предлагает доступный IP-адрес (остальные узлы игнорируют это сообщение).
    
- `DHCP Request` — клиент подтверждает выбор адреса.
    
- `DHCP Ack` — сервер завершает настройку, передавая клиенту все параметры сети.
# ARP 

- Работает на канальном уровне 
- Выполняет задачу определения MAC-адреса
## Принцип работы:

- Устройство отправляет широковещательный ARP-запрос: `«У кого IP 192.168.1.1?»`.
    
- Устройство с этим IP отвечает своим MAC-адресом.

# ICMP

- Работает как надстройка над протоколом IP
- Выполняет передачу диагностических сообщений на сетевом ур.
- Можно выявить неполадки сетевого подключения 

## `ping <name_package>` - направляет серию ICMP requests и измеряет: 
- **Факт получения ответа**
- **Время прохождение пакета**


# Traceroute 

- Позволяет отобразить полный сетевой путь до конечного устройства
- Определяет ICMP time exceeded пакеты увеличивая TTL
	- Определяет весь путь до целевого узла
	- Время отклика каждого промежуточного маршрутизатора
## `traceroute <name_package>`


# Дополнительно 

1. Поскольку злоумышленники часто используют ICMP в DoS- и DDoS-атаках, многие серверы в сети, находящиеся за межсетевыми экранами и другими средствами защиты, игнорируют такие пакеты. В то же время, они могут штатно обрабатывать другие запросы, например, HTTP. **Отсутствие ответа на ping еще не говорит о том, что узел недоступен.**
2. Иногда маршрутизаторы могут отдавать сообщение `Destination Host Unreachable` при попытке проверить его доступность. Это указывает на то, что **маршрутизатор не может доставить пакет до указанного адресата.** Сообщение `Request Timed Out` сообщает о превышении TTL пакета, такое может происходить, например, при блокировке ICMP-пакетов межсетевым экраном.
3. Служебные протоколы DHCP, ARP и ICMP подвержены разным атакам, например, [DHCP Rogue](https://en.wikipedia.org/wiki/Rogue_DHCP) или [ARP Spoofing](https://habr.com/ru/articles/786038/), поэтому принято вводить меры безопасности, направленные на их защиту.
